/**
 * Model Tier Mapping Editor
 * Configure opus/sonnet/haiku model overrides
 */

import { useMemo } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Wand2, ChevronRight } from 'lucide-react';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { useOpenRouterCatalog } from '@/hooks/use-openrouter-models';
import { suggestTierMappings } from '@/lib/openrouter-utils';
import { cn } from '@/lib/utils';

export interface TierMapping {
  opus?: string;
  sonnet?: string;
  haiku?: string;
}

interface ModelTierMappingProps {
  selectedModel?: string;
  value: TierMapping;
  onChange: (mapping: TierMapping) => void;
  className?: string;
}

export function ModelTierMapping({
  selectedModel,
  value,
  onChange,
  className,
}: ModelTierMappingProps) {
  const { models } = useOpenRouterCatalog();

  const suggestions = useMemo(() => {
    if (!selectedModel) return {};
    return suggestTierMappings(selectedModel, models);
  }, [selectedModel, models]);

  const handleAutoSuggest = () => {
    onChange(suggestions);
  };

  const updateTier = (tier: keyof TierMapping, modelId: string) => {
    onChange({ ...value, [tier]: modelId || undefined });
  };

  const hasSuggestions = selectedModel && Object.keys(suggestions).length > 0;

  return (
    <Collapsible className={cn('group', className)}>
      <CollapsibleTrigger className="flex items-center gap-2 text-sm font-medium hover:underline">
        <ChevronRight className="h-4 w-4 transition-transform group-data-[state=open]:rotate-90" />
        Model Tier Mapping
        <span className="text-muted-foreground font-normal">(Advanced)</span>
      </CollapsibleTrigger>
      <CollapsibleContent className="space-y-3 pt-3">
        <p className="text-muted-foreground text-sm">
          Configure different models for Claude Code&apos;s opus/sonnet/haiku tiers.
        </p>

        {hasSuggestions && (
          <Button type="button" variant="outline" size="sm" onClick={handleAutoSuggest}>
            <Wand2 className="mr-1 h-4 w-4" />
            Auto-suggest based on {selectedModel?.split('/')[0]}
          </Button>
        )}

        <div className="grid gap-3">
          <div className="grid grid-cols-[80px_1fr] items-center gap-2">
            <Label htmlFor="tier-opus" className="text-right">
              Opus
            </Label>
            <Input
              id="tier-opus"
              value={value.opus ?? ''}
              onChange={(e) => updateTier('opus', e.target.value)}
              placeholder="e.g., anthropic/claude-opus-4"
            />
          </div>
          <div className="grid grid-cols-[80px_1fr] items-center gap-2">
            <Label htmlFor="tier-sonnet" className="text-right">
              Sonnet
            </Label>
            <Input
              id="tier-sonnet"
              value={value.sonnet ?? ''}
              onChange={(e) => updateTier('sonnet', e.target.value)}
              placeholder="e.g., anthropic/claude-sonnet-4"
            />
          </div>
          <div className="grid grid-cols-[80px_1fr] items-center gap-2">
            <Label htmlFor="tier-haiku" className="text-right">
              Haiku
            </Label>
            <Input
              id="tier-haiku"
              value={value.haiku ?? ''}
              onChange={(e) => updateTier('haiku', e.target.value)}
              placeholder="e.g., anthropic/claude-3.5-haiku"
            />
          </div>
        </div>

        <p className="text-muted-foreground text-xs">
          These set ANTHROPIC_DEFAULT_OPUS_MODEL, ANTHROPIC_DEFAULT_SONNET_MODEL,
          ANTHROPIC_DEFAULT_HAIKU_MODEL.
        </p>
      </CollapsibleContent>
    </Collapsible>
  );
}
